name: Vultr Snapshot Backup

on:
  schedule:
    # æ¯6å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 */6 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  snapshot-backup:
    runs-on: ubuntu-latest
    env:
      VULTR_API_URL: https://api.vultr.com/v2
      # åœ¨ä»“åº“ Secrets ä¸­è®¾ç½® VULTR_API_KEY
      VULTR_API_KEY: ${{ secrets.VULTR_API_KEY }}
      # ç­‰å¾…è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ã€è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰
      TIMEOUT: 3600
      INTERVAL: 60

    steps:
      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: æ‰§è¡Œ Vultr å¿«ç…§å¤‡ä»½
        run: |
          echo "ğŸ”” å¼€å§‹ Vultr å¿«ç…§å¤‡ä»½æµç¨‹"

          # ç»Ÿè®¡å˜é‡
          DEL_COUNT=0
          INST_COUNT=0
          CREATED_COUNT=0
          FAILED_COUNT=0

          #############################################################################
          # ç¬¬ä¸€æ­¥ï¼šè·å–å¹¶åˆ é™¤æ‰€æœ‰ç°æœ‰å¿«ç…§
          #############################################################################
          echo "::group::1. åˆ é™¤æ‰€æœ‰ç°æœ‰å¿«ç…§"
          RESPONSE=$(curl -s -H "Authorization: Bearer $VULTR_API_KEY" \
                         "$VULTR_API_URL/snapshots" -w "\n%{http_code}")
          BODY=$(echo "$RESPONSE" | sed '$d')
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::è·å–å¿«ç…§åˆ—è¡¨å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç ï¼š$HTTP_CODE"
            exit 1
          fi

          SNAP_IDS=$(echo "$BODY" | jq -r '.snapshots[]?.id')
          for SID in $SNAP_IDS; do
            echo "  - åˆ é™¤å¿«ç…§ $SID â€¦"
            RES=$(curl -s -X DELETE -H "Authorization: Bearer $VULTR_API_KEY" \
                        "$VULTR_API_URL/snapshots/$SID" -w "\n%{http_code}")
            CODE=$(echo "$RES" | tail -n1)
            if [[ $CODE -ge 200 && $CODE -lt 300 ]]; then
              echo "    âœ” åˆ é™¤æˆåŠŸ"
              DEL_COUNT=$((DEL_COUNT+1))
            else
              echo "    âš  åˆ é™¤å¤±è´¥ï¼ŒHTTP $CODE"
            fi
            sleep 1
          done
          echo "å·²åˆ é™¤å¿«ç…§æ•°é‡ï¼š$DEL_COUNT"
          echo "::endgroup::"

          #############################################################################
          # ç¬¬äºŒæ­¥ï¼šè·å–æ‰€æœ‰å®ä¾‹ä¿¡æ¯å¹¶å±•ç¤º
          #############################################################################
          echo "::group::2. åˆ—å‡ºæ‰€æœ‰å®ä¾‹"
          RESP2=$(curl -s -H "Authorization: Bearer $VULTR_API_KEY" \
                          "$VULTR_API_URL/instances" -w "\n%{http_code}")
          BODY2=$(echo "$RESP2" | sed '$d')
          CODE2=$(echo "$RESP2" | tail -n1)
          if [[ "$CODE2" != "200" ]]; then
            echo "::error::è·å–å®ä¾‹åˆ—è¡¨å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç ï¼š$CODE2"
            exit 1
          fi

          # è·å–å®ä¾‹ ID åˆ—è¡¨
          IDS=$(echo "$BODY2" | jq -r '.instances[]?.id')
          INST_COUNT=$(echo "$IDS" | wc -l)
          echo "å‘ç°å®ä¾‹æ•°é‡ï¼š$INST_COUNT"
          echo "$BODY2" | jq -r '.instances[] | "  â€¢ ID:$$.id)  çŠ¶æ€:$$.status)  ç”µæºçŠ¶æ€:$$.power_status)  æ–¹æ¡ˆ:$$.plan)  åŒºåŸŸ:$$.region)"'
          echo "::endgroup::"

          #############################################################################
          # ç¬¬ä¸‰æ­¥ï¼šä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºæ–°å¿«ç…§
          #############################################################################
          echo "::group::3. åˆ›å»ºæ–°å¿«ç…§"
          declare -A SNAP_MAP
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          for IID in $IDS; do
            DESC="backup-${IID}-${TIMESTAMP}"
            echo "  - å®ä¾‹ $IID åˆ›å»ºå¿«ç…§ï¼ˆæè¿°ï¼š$DESCï¼‰"
            R=$(curl -s -X POST -H "Authorization: Bearer $VULTR_API_KEY" \
                       -H "Content-Type: application/json" \
                       -d "{\"description\":\"$DESC\"}" \
                       "$VULTR_API_URL/instances/$IID/snapshots" \
                       -w "\n%{http_code}")
            B=$(echo "$R" | sed '$d')
            C=$(echo "$R" | tail -n1)
            if [[ "$C" == "200" || "$C" == "202" ]]; then
              SID=$(echo "$B" | jq -r '.snapshot.id')
              echo "    âœ” è¯·æ±‚å·²æ¥å—ï¼Œå¿«ç…§ IDï¼š$SID"
              SNAP_MAP["$SID"]=$IID
              CREATED_COUNT=$((CREATED_COUNT+1))
            else
              echo "    âš  åˆ›å»ºå¤±è´¥ï¼ŒHTTP $Cï¼Œå“åº”ï¼š$B"
              FAILED_COUNT=$((FAILED_COUNT+1))
            fi
            sleep 1
          done
          echo "å¿«ç…§åˆ›å»ºè¯·æ±‚å·²å‘èµ·ï¼šæˆåŠŸ $CREATED_COUNTï¼Œå¤±è´¥ $FAILED_COUNT"
          echo "::endgroup::"

          #############################################################################
          # ç¬¬å››æ­¥ï¼šç›‘æ§å¿«ç…§çŠ¶æ€ç›´åˆ°å®Œæˆæˆ–è¶…æ—¶
          #############################################################################
          echo "::group::4. ç›‘æ§å¿«ç…§åˆ›å»ºçŠ¶æ€"
          for SID in "${!SNAP_MAP[@]}"; do
            ELAPSED=0
            echo "  - ç­‰å¾…å¿«ç…§ $SID å®Œæˆâ€¦"
            while true; do
              Q=$(curl -s -H "Authorization: Bearer $VULTR_API_KEY" \
                       "$VULTR_API_URL/snapshots/$SID" -w "\n%{http_code}")
              BL=$(echo "$Q" | sed '$d')
              HC=$(echo "$Q" | tail -n1)
              if [[ "$HC" != "200" ]]; then
                echo "    âš  æŸ¥è¯¢å¤±è´¥ï¼ŒHTTP $HC"
                FAILED_COUNT=$((FAILED_COUNT+1))
                break
              fi
              ST=$(echo "$BL" | jq -r '.snapshot.status')
              echo "    â€¢ çŠ¶æ€ï¼š$ST"
              if [[ "$ST" == "complete" ]]; then
                echo "    âœ” å·²å®Œæˆ"
                break
              fi
              if [[ $ELAPSED -ge $TIMEOUT ]]; then
                echo "    â° è¶…æ—¶ï¼ˆ${TIMEOUT}sï¼‰"
                FAILED_COUNT=$((FAILED_COUNT+1))
                break
              fi
              echo "    ç­‰å¾… ${INTERVAL}s åé‡è¯•â€¦"
              sleep $INTERVAL
              ELAPSED=$((ELAPSED+INTERVAL))
            done
          done
          echo "::endgroup::"

          #############################################################################
          # æœ€ç»ˆæŠ¥å‘Š
          #############################################################################
          echo "::group::æ“ä½œæ€»ç»“"
          echo "âœ” å·²åˆ é™¤å¿«ç…§æ•°ï¼š$DEL_COUNT"
          echo "âœ” å®ä¾‹æ€»æ•°ï¼š$INST_COUNT"
          echo "âœ” å‘èµ·å¿«ç…§åˆ›å»ºï¼š$CREATED_COUNT"
          echo "â— å¤±è´¥æ¬¡æ•°ï¼š$FAILED_COUNT"
          echo "::endgroup::"

          # å¦‚æœæœ‰å¤±è´¥ï¼Œæ ‡è®° Job å¤±è´¥
          if [[ $FAILED_COUNT -gt 0 ]]; then
            echo "::error::æ£€æµ‹åˆ° $FAILED_COUNT ä¸ªå¤±è´¥ï¼ŒåŠ¨ä½œç»“æŸçŠ¶æ€ï¼šå¤±è´¥"
            exit 1
          fi

        shell: bash
