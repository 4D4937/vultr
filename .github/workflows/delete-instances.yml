name: Vultr Automated Snapshot Management

on:
  # æ¯6å°æ—¶è‡ªåŠ¨è¿è¡Œï¼ˆUTCæ—¶é—´ï¼š00:00, 06:00, 12:00, 18:00ï¼‰
  schedule:
    - cron: '0 */6 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_delete:
        description: 'å¼ºåˆ¶åˆ é™¤æ‰€æœ‰ç°æœ‰å¿«ç…§ï¼ˆtrue/falseï¼‰'
        required: false
        default: 'true'
        type: boolean
      timeout_minutes:
        description: 'å¿«ç…§åˆ›å»ºè¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        default: '30'
        type: string

env:
  VULTR_API_KEY: ${{ secrets.VULTR_API_KEY }}
  VULTR_API_URL: "https://api.vultr.com/v2"

jobs:
  snapshot-management:
    name: Vultr Snapshot Management
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: ğŸ”§ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“‹ Setup Environment
      run: |
        echo "WORKFLOW_START_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
        echo "SNAPSHOT_TIMESTAMP=$(date '+%Y%m%d_%H%M%S')" >> $GITHUB_ENV
        echo "TIMEOUT_MINUTES=${{ github.event.inputs.timeout_minutes || '30' }}" >> $GITHUB_ENV
        echo "FORCE_DELETE=${{ github.event.inputs.force_delete || 'true' }}" >> $GITHUB_ENV

    - name: âœ… Validate API Configuration
      run: |
        if [ -z "$VULTR_API_KEY" ]; then
          echo "âŒ é”™è¯¯: VULTR_API_KEY æœªè®¾ç½®"
          echo "è¯·åœ¨ä»“åº“çš„ Settings > Secrets ä¸­æ·»åŠ  VULTR_API_KEY"
          exit 1
        fi
        
        echo "ğŸ” APIå¯†é’¥å·²é…ç½®"
        echo "ğŸŒ APIç«¯ç‚¹: $VULTR_API_URL"
        echo "â° å·¥ä½œæµå¯åŠ¨æ—¶é—´: $WORKFLOW_START_TIME"

    - name: ğŸ—‘ï¸ ç¬¬ä¸€æ­¥ï¼šåˆ é™¤ç°æœ‰å¿«ç…§
      id: delete_snapshots
      run: |
        echo "=== å¼€å§‹åˆ é™¤ç°æœ‰å¿«ç…§ ==="
        
        # è·å–æ‰€æœ‰å¿«ç…§
        echo "ğŸ“¡ è·å–ç°æœ‰å¿«ç…§åˆ—è¡¨..."
        snapshots_response=$(curl -s -H "Authorization: Bearer $VULTR_API_KEY" \
          "$VULTR_API_URL/snapshots")
        
        if [ $? -ne 0 ]; then
          echo "âŒ è·å–å¿«ç…§åˆ—è¡¨å¤±è´¥"
          exit 1
        fi
        
        snapshot_count=$(echo "$snapshots_response" | jq -r '.snapshots | length // 0')
        echo "ğŸ“Š å‘ç° $snapshot_count ä¸ªç°æœ‰å¿«ç…§"
        
        if [ "$snapshot_count" -eq 0 ]; then
          echo "âœ… æ²¡æœ‰ç°æœ‰å¿«ç…§éœ€è¦åˆ é™¤"
          echo "deleted_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # åˆ é™¤å¿«ç…§
        deleted_count=0
        failed_count=0
        
        echo "$snapshots_response" | jq -r '.snapshots[]? | select(.id != null) | @base64' | while read -r snapshot_data; do
          snapshot=$(echo "$snapshot_data" | base64 --decode)
          snapshot_id=$(echo "$snapshot" | jq -r '.id')
          snapshot_desc=$(echo "$snapshot" | jq -r '.description // "æ— æè¿°"')
          created_date=$(echo "$snapshot" | jq -r '.date_created // "æœªçŸ¥æ—¶é—´"')
          
          echo "ğŸ—‘ï¸ åˆ é™¤å¿«ç…§: $snapshot_id ($snapshot_desc, åˆ›å»ºäº: $created_date)"
          
          if [ "$FORCE_DELETE" == "true" ]; then
            delete_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
              -X DELETE "$VULTR_API_URL/snapshots/$snapshot_id")
            
            http_code=$(echo "$delete_response" | tail -c 4)
            
            if [ "$http_code" = "204" ] || [ "$http_code" = "200" ]; then
              echo "   âœ… æˆåŠŸåˆ é™¤"
              ((deleted_count++))
            else
              echo "   âŒ åˆ é™¤å¤±è´¥ (HTTP $http_code)"
              ((failed_count++))
            fi
          else
            echo "   âš ï¸ è·³è¿‡åˆ é™¤ (force_delete=false)"
          fi
          
          # é¿å…APIé™åˆ¶
          sleep 2
        done
        
        echo "deleted_count=$deleted_count" >> $GITHUB_OUTPUT
        echo "failed_count=$failed_count" >> $GITHUB_OUTPUT
        echo "=== å¿«ç…§åˆ é™¤å®Œæˆ ==="

    - name: ğŸ“‹ ç¬¬äºŒæ­¥ï¼šè·å–Vultrå®ä¾‹ä¿¡æ¯
      id: get_instances
      run: |
        echo "=== è·å–Vultrå®ä¾‹ä¿¡æ¯ ==="
        
        # è·å–æ‰€æœ‰å®ä¾‹
        instances_response=$(curl -s -H "Authorization: Bearer $VULTR_API_KEY" \
          "$VULTR_API_URL/instances")
        
        if [ $? -ne 0 ]; then
          echo "âŒ è·å–å®ä¾‹åˆ—è¡¨å¤±è´¥"
          exit 1
        fi
        
        # æ£€æŸ¥å“åº”æ ¼å¼
        instance_count=$(echo "$instances_response" | jq -r '.instances | length // 0')
        echo "ğŸ“Š å‘ç° $instance_count ä¸ªå®ä¾‹"
        
        if [ "$instance_count" -eq 0 ]; then
          echo "âš ï¸ æ²¡æœ‰å‘ç°ä»»ä½•å®ä¾‹"
          echo "instance_count=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ˜¾ç¤ºå®ä¾‹è¯¦æƒ…
        echo "ğŸ“‹ å®ä¾‹è¯¦ç»†ä¿¡æ¯:"
        echo "$instances_response" | jq -r '
          .instances[]? | 
          "ğŸ–¥ï¸ å®ä¾‹ID: \(.id // "æœªçŸ¥")
           ğŸ“ æ ‡ç­¾: \(.label // "æœªå‘½å")
           ğŸ”‹ çŠ¶æ€: \(.status // "æœªçŸ¥") | ç”µæº: \(.power_status // "æœªçŸ¥")
           ğŸ’¾ è®¡åˆ’: \(.plan // "æœªçŸ¥") | åŒºåŸŸ: \(.region // "æœªçŸ¥")
           ğŸŒ ä¸»IP: \(.main_ip // "æœªåˆ†é…")
           ğŸ“… åˆ›å»ºæ—¶é—´: \(.date_created // "æœªçŸ¥")
           =================="
        '
        
        # ä¿å­˜æ´»è·ƒå®ä¾‹ID
        active_instances=$(echo "$instances_response" | jq -r '
          [.instances[]? | select(.status == "active") | .id] | join(" ")
        ')
        
        active_count=$(echo "$instances_response" | jq -r '
          [.instances[]? | select(.status == "active")] | length
        ')
        
        echo "ğŸŸ¢ æ´»è·ƒå®ä¾‹æ•°é‡: $active_count"
        echo "active_instances=$active_instances" >> $GITHUB_OUTPUT
        echo "instance_count=$instance_count" >> $GITHUB_OUTPUT
        echo "active_count=$active_count" >> $GITHUB_OUTPUT

    - name: ğŸ“¸ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ–°å¿«ç…§
      id: create_snapshots
      run: |
        echo "=== å¼€å§‹åˆ›å»ºæ–°å¿«ç…§ ==="
        
        active_instances="${{ steps.get_instances.outputs.active_instances }}"
        active_count="${{ steps.get_instances.outputs.active_count }}"
        
        if [ "$active_count" -eq 0 ]; then
          echo "âš ï¸ æ²¡æœ‰æ´»è·ƒå®ä¾‹ï¼Œè·³è¿‡å¿«ç…§åˆ›å»º"
          echo "created_snapshots=" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        created_snapshots=""
        success_count=0
        
        for instance_id in $active_instances; do
          echo "ğŸ“¸ ä¸ºå®ä¾‹ $instance_id åˆ›å»ºå¿«ç…§..."
          
          # ç”Ÿæˆå¿«ç…§æè¿°
          snapshot_desc="AutoBackup_${SNAPSHOT_TIMESTAMP}_${instance_id}"
          
          # åˆ›å»ºå¿«ç…§
          create_response=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
            -H "Content-Type: application/json" \
            -X POST "$VULTR_API_URL/snapshots" \
            -d "{
              \"instance_id\": \"$instance_id\",
              \"description\": \"$snapshot_desc\"
            }")
          
          http_code=$(echo "$create_response" | tail -1)
          response_body=$(echo "$create_response" | head -n -1)
          
          if [ "$http_code" = "201" ] || [ "$http_code" = "200" ]; then
            snapshot_id=$(echo "$response_body" | jq -r '.snapshot.id // empty')
            if [ -n "$snapshot_id" ]; then
              echo "   âœ… å¿«ç…§åˆ›å»ºè¯·æ±‚æˆåŠŸ - ID: $snapshot_id"
              created_snapshots="$created_snapshots $snapshot_id"
              ((success_count++))
            else
              echo "   âš ï¸ å¿«ç…§åˆ›å»ºå“åº”æ ¼å¼å¼‚å¸¸"
            fi
          else
            echo "   âŒ å¿«ç…§åˆ›å»ºå¤±è´¥ (HTTP $http_code)"
            echo "   å“åº”: $response_body"
          fi
          
          # é¿å…APIé™åˆ¶
          sleep 3
        done
        
        echo "created_snapshots=$created_snapshots" >> $GITHUB_OUTPUT
        echo "success_count=$success_count" >> $GITHUB_OUTPUT
        echo "=== å¿«ç…§åˆ›å»ºè¯·æ±‚å®Œæˆ ==="

    - name: â³ ç¬¬å››æ­¥ï¼šç›‘æ§å¿«ç…§åˆ›å»ºçŠ¶æ€
      id: monitor_snapshots
      run: |
        echo "=== ç›‘æ§å¿«ç…§åˆ›å»ºçŠ¶æ€ ==="
        
        created_snapshots="${{ steps.create_snapshots.outputs.created_snapshots }}"
        timeout_minutes="$TIMEOUT_MINUTES"
        
        if [ -z "$created_snapshots" ]; then
          echo "âš ï¸ æ²¡æœ‰éœ€è¦ç›‘æ§çš„å¿«ç…§"
          exit 0
        fi
        
        echo "ğŸ“Š ç›‘æ§å¿«ç…§: $created_snapshots"
        echo "â±ï¸ è¶…æ—¶æ—¶é—´: $timeout_minutes åˆ†é’Ÿ"
        
        start_time=$(date +%s)
        timeout_seconds=$((timeout_minutes * 60))
        completed_count=0
        total_snapshots=$(echo $created_snapshots | wc -w)
        
        while [ $completed_count -lt $total_snapshots ]; do
          current_time=$(date +%s)
          elapsed=$((current_time - start_time))
          
          if [ $elapsed -gt $timeout_seconds ]; then
            echo "â° ç›‘æ§è¶…æ—¶ ($timeout_minutes åˆ†é’Ÿ)"
            break
          fi
          
          echo "ğŸ”„ æ£€æŸ¥å¿«ç…§çŠ¶æ€... (å·²ç”¨æ—¶: $((elapsed/60))åˆ†é’Ÿ)"
          completed_count=0
          
          for snapshot_id in $created_snapshots; do
            status_response=$(curl -s -H "Authorization: Bearer $VULTR_API_KEY" \
              "$VULTR_API_URL/snapshots/$snapshot_id")
            
            if [ $? -eq 0 ]; then
              status=$(echo "$status_response" | jq -r '.snapshot.status // "unknown"')
              description=$(echo "$status_response" | jq -r '.snapshot.description // "æœªçŸ¥"')
              
              case "$status" in
                "complete")
                  echo "   âœ… $snapshot_id: å®Œæˆ ($description)"
                  ((completed_count++))
                  ;;
                "pending")
                  echo "   â³ $snapshot_id: åˆ›å»ºä¸­ ($description)"
                  ;;
                *)
                  echo "   â“ $snapshot_id: $status ($description)"
                  ;;
              esac
            else
              echo "   âŒ $snapshot_id: çŠ¶æ€æ£€æŸ¥å¤±è´¥"
            fi
          done
          
          echo "ğŸ“ˆ è¿›åº¦: $completed_count/$total_snapshots å®Œæˆ"
          
          if [ $completed_count -lt $total_snapshots ]; then
            echo "ğŸ’¤ ç­‰å¾…30ç§’åé‡æ–°æ£€æŸ¥..."
            sleep 30
          fi
        done
        
        echo "final_completed=$completed_count" >> $GITHUB_OUTPUT
        echo "total_snapshots=$total_snapshots" >> $GITHUB_OUTPUT
        echo "=== å¿«ç…§ç›‘æ§å®Œæˆ ==="

    - name: ğŸ“Š ç”Ÿæˆæ“ä½œæ€»ç»“æŠ¥å‘Š
      run: |
        echo "=== Vultrå¿«ç…§ç®¡ç†æ€»ç»“æŠ¥å‘Š ==="
        echo "ğŸ• æ‰§è¡Œæ—¶é—´: $WORKFLOW_START_TIME"
        echo "âš™ï¸ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ‘¤ æ‰‹åŠ¨è§¦å‘å‚æ•°:"
          echo "   - å¼ºåˆ¶åˆ é™¤: ${{ github.event.inputs.force_delete }}"
          echo "   - è¶…æ—¶æ—¶é—´: ${{ github.event.inputs.timeout_minutes }}åˆ†é’Ÿ"
        fi
        
        echo ""
        echo "ğŸ“‹ æ“ä½œç»“æœ:"
        
        # åˆ é™¤å¿«ç…§ç»“æœ
        deleted_count="${{ steps.delete_snapshots.outputs.deleted_count || '0' }}"
        echo "ğŸ—‘ï¸ åˆ é™¤å¿«ç…§: $deleted_count ä¸ª"
        
        # å®ä¾‹ä¿¡æ¯
        total_instances="${{ steps.get_instances.outputs.instance_count || '0' }}"
        active_instances="${{ steps.get_instances.outputs.active_count || '0' }}"
        echo "ğŸ–¥ï¸ æ€»å®ä¾‹æ•°: $total_instances ä¸ª"
        echo "ğŸŸ¢ æ´»è·ƒå®ä¾‹: $active_instances ä¸ª"
        
        # å¿«ç…§åˆ›å»ºç»“æœ
        created_count="${{ steps.create_snapshots.outputs.success_count || '0' }}"
        completed_count="${{ steps.monitor_snapshots.outputs.final_completed || '0' }}"
        total_snapshots="${{ steps.monitor_snapshots.outputs.total_snapshots || '0' }}"
        
        echo "ğŸ“¸ å¿«ç…§åˆ›å»ºè¯·æ±‚: $created_count ä¸ª"
        echo "âœ… å¿«ç…§åˆ›å»ºå®Œæˆ: $completed_count/$total_snapshots ä¸ª"
        
        # çŠ¶æ€åˆ¤æ–­
        if [ "$completed_count" -eq "$total_snapshots" ] && [ "$total_snapshots" -gt 0 ]; then
          echo "ğŸ‰ çŠ¶æ€: å…¨éƒ¨æˆåŠŸ"
        elif [ "$completed_count" -gt 0 ]; then
          echo "âš ï¸ çŠ¶æ€: éƒ¨åˆ†æˆåŠŸ"
        elif [ "$total_snapshots" -gt 0 ]; then
          echo "âŒ çŠ¶æ€: å¤±è´¥"
        else
          echo "ğŸ’¡ çŠ¶æ€: æ— æ“ä½œéœ€è¦æ‰§è¡Œ"
        fi
        
        echo ""
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: 6å°æ—¶å"
        echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘: è®¿é—® Actions æ ‡ç­¾é¡µ"
        echo "==============================================="

    - name: ğŸš¨ é”™è¯¯é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥!"
        echo "ğŸ“… å¤±è´¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ” è¯·æ£€æŸ¥ä¸Šè¿°æ­¥éª¤çš„é”™è¯¯æ—¥å¿—"
        echo "ğŸ’¡ å¸¸è§é—®é¢˜:"
        echo "   1. æ£€æŸ¥ VULTR_API_KEY æ˜¯å¦æ­£ç¡®è®¾ç½®"
        echo "   2. ç¡®è®¤APIå¯†é’¥æœ‰è¶³å¤Ÿæƒé™"
        echo "   3. æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€"
        echo "   4. éªŒè¯Vultr APIæœåŠ¡çŠ¶æ€"
