name: Vultr Automated Snapshot Management with Instance Cleanup

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_delete:
        description: 'å¼ºåˆ¶åˆ é™¤æ‰€æœ‰ç°æœ‰å¿«ç…§ï¼ˆtrue/falseï¼‰'
        required: false
        default: 'true'
        type: boolean
      timeout_minutes:
        description: 'å¿«ç…§åˆ›å»ºè¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰'
        required: false
        default: '30'
        type: string
      delete_instances:
        description: 'å¿«ç…§æˆåŠŸååˆ é™¤æ‰€æœ‰å®ä¾‹ï¼ˆtrue/falseï¼‰'
        required: false
        default: 'true'
        type: boolean

env:
  VULTR_API_KEY: ${{ secrets.VULTR_API_KEY }}
  VULTR_API_URL: "https://api.vultr.com/v2"

jobs:
  snapshot-management:
    name: Vultr Snapshot Management
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: ğŸ”§ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“‹ Setup Environment
      run: |
        echo "WORKFLOW_START_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV
        echo "SNAPSHOT_TIMESTAMP=$(date '+%Y%m%d_%H%M%S')" >> $GITHUB_ENV
        echo "TIMEOUT_MINUTES=${{ github.event.inputs.timeout_minutes || '30' }}" >> $GITHUB_ENV
        echo "FORCE_DELETE=${{ github.event.inputs.force_delete || 'true' }}" >> $GITHUB_ENV
        echo "DELETE_INSTANCES=${{ github.event.inputs.delete_instances || 'true' }}" >> $GITHUB_ENV
        
        # åˆå§‹åŒ–çŠ¶æ€æ–‡ä»¶
        echo "0" > /tmp/deleted_count
        echo "0" > /tmp/failed_delete_count
        echo "" > /tmp/created_snapshots
        echo "0" > /tmp/success_count
        echo "0" > /tmp/instances_deleted
        echo "0" > /tmp/instances_delete_failed

    - name: âœ… Validate API Configuration
      run: |
        if [ -z "$VULTR_API_KEY" ]; then
          echo "âŒ é”™è¯¯: VULTR_API_KEY æœªè®¾ç½®"
          echo "è¯·åœ¨ä»“åº“çš„ Settings > Secrets ä¸­æ·»åŠ  VULTR_API_KEY"
          exit 1
        fi
        
        # æµ‹è¯•APIè¿æ¥
        echo "ğŸ” æµ‹è¯•APIè¿æ¥..."
        test_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
          "$VULTR_API_URL/account" -o /tmp/api_test.json)
        
        if [ "$test_response" != "200" ]; then
          echo "âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥ (HTTP $test_response)"
          echo "è¯·æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ"
          exit 1
        fi
        
        echo "âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸ"
        echo "ğŸŒ APIç«¯ç‚¹: $VULTR_API_URL"
        echo "â° å·¥ä½œæµå¯åŠ¨æ—¶é—´: $WORKFLOW_START_TIME"
        echo "ğŸ—‘ï¸ åˆ é™¤å®ä¾‹è®¾ç½®: $DELETE_INSTANCES"

    - name: ğŸ—‘ï¸ ç¬¬ä¸€æ­¥ï¼šåˆ é™¤ç°æœ‰å¿«ç…§
      run: |
        echo "=== å¼€å§‹åˆ é™¤ç°æœ‰å¿«ç…§ ==="
        
        # è·å–æ‰€æœ‰å¿«ç…§
        echo "ğŸ“¡ è·å–ç°æœ‰å¿«ç…§åˆ—è¡¨..."
        snapshots_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
          "$VULTR_API_URL/snapshots" -o /tmp/snapshots.json)
        
        http_code=$(echo "$snapshots_response" | tail -c 4)
        if [ "$http_code" != "200" ]; then
          echo "âŒ è·å–å¿«ç…§åˆ—è¡¨å¤±è´¥ (HTTP $http_code)"
          exit 1
        fi
        
        snapshot_count=$(jq -r '.snapshots | length // 0' /tmp/snapshots.json)
        echo "ğŸ“Š å‘ç° $snapshot_count ä¸ªç°æœ‰å¿«ç…§"
        
        if [ "$snapshot_count" -eq 0 ]; then
          echo "âœ… æ²¡æœ‰ç°æœ‰å¿«ç…§éœ€è¦åˆ é™¤"
          echo "0" > /tmp/deleted_count
          echo "false" > /tmp/snapshots_deleted
        else
          deleted_count=0
          failed_count=0
          
          # åˆ é™¤æ¯ä¸ªå¿«ç…§
          jq -r '.snapshots[]? | select(.id != null) | .id' /tmp/snapshots.json | while read -r snapshot_id; do
            if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "null" ]; then
              snapshot_info=$(jq -r --arg id "$snapshot_id" '.snapshots[] | select(.id == $id)' /tmp/snapshots.json)
              snapshot_desc=$(echo "$snapshot_info" | jq -r '.description // "æ— æè¿°"')
              created_date=$(echo "$snapshot_info" | jq -r '.date_created // "æœªçŸ¥æ—¶é—´"')
              
              echo "ğŸ—‘ï¸ åˆ é™¤å¿«ç…§: $snapshot_id ($snapshot_desc, åˆ›å»ºäº: $created_date)"
              
              if [ "$FORCE_DELETE" == "true" ]; then
                delete_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
                  -X DELETE "$VULTR_API_URL/snapshots/$snapshot_id" -o /tmp/delete_response.json)
                
                delete_http_code=$(echo "$delete_response" | tail -c 4)
                
                if [ "$delete_http_code" = "204" ] || [ "$delete_http_code" = "200" ] || [ "$delete_http_code" = "404" ]; then
                  echo "   âœ… æˆåŠŸåˆ é™¤"
                  deleted_count=$((deleted_count + 1))
                else
                  echo "   âŒ åˆ é™¤å¤±è´¥ (HTTP $delete_http_code)"
                  failed_count=$((failed_count + 1))
                fi
              else
                echo "   âš ï¸ è·³è¿‡åˆ é™¤ (force_delete=false)"
              fi
              
              # é¿å…APIé™åˆ¶
              sleep 2
            fi
          done
          
          echo "$deleted_count" > /tmp/deleted_count
          echo "$failed_count" > /tmp/failed_delete_count
          
          # æ ‡è®°æœ‰å¿«ç…§è¢«åˆ é™¤
          if [ "$deleted_count" -gt 0 ]; then
            echo "true" > /tmp/snapshots_deleted
          else
            echo "false" > /tmp/snapshots_deleted
          fi
        fi
        
        echo "=== å¿«ç…§åˆ é™¤å®Œæˆ ==="

    - name: â³ ç­‰å¾…æ¸…ç†å®Œæˆ
      run: |
        snapshots_deleted=$(cat /tmp/snapshots_deleted 2>/dev/null || echo "false")
        deleted_count=$(cat /tmp/deleted_count 2>/dev/null || echo "0")
        
        if [ "$snapshots_deleted" == "true" ] && [ "$deleted_count" -gt 0 ]; then
          echo "=== ç­‰å¾…å¿«ç…§åˆ é™¤å®Œå…¨å®Œæˆ ==="
          echo "â³ å·²åˆ é™¤ $deleted_count ä¸ªå¿«ç…§ï¼Œç­‰å¾…ç³»ç»Ÿæ¸…ç†..."
          echo "ğŸ’¤ ç­‰å¾…5åˆ†é’Ÿä»¥ç¡®ä¿åˆ é™¤æ“ä½œå®Œå…¨å®Œæˆ..."
          
          # 5åˆ†é’Ÿå€’è®¡æ—¶æ˜¾ç¤º
          total_seconds=300
          for i in $(seq $total_seconds -30 1); do
            minutes=$((i / 60))
            seconds=$((i % 60))
            printf "\râ° å‰©ä½™æ—¶é—´: %02d:%02d" $minutes $seconds
            sleep 30
          done
          printf "\râœ… ç­‰å¾…å®Œæˆï¼Œç³»ç»Ÿå·²æ¸…ç†        \n"
        else
          echo "â„¹ï¸ æ²¡æœ‰åˆ é™¤å¿«ç…§ï¼Œæ— éœ€ç­‰å¾…"
        fi

    - name: ğŸ“‹ ç¬¬äºŒæ­¥ï¼šè·å–Vultrå®ä¾‹ä¿¡æ¯
      run: |
        echo "=== è·å–Vultrå®ä¾‹ä¿¡æ¯ ==="
        
        # è·å–æ‰€æœ‰å®ä¾‹
        instances_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
          "$VULTR_API_URL/instances" -o /tmp/instances.json)
        
        http_code=$(echo "$instances_response" | tail -c 4)
        if [ "$http_code" != "200" ]; then
          echo "âŒ è·å–å®ä¾‹åˆ—è¡¨å¤±è´¥ (HTTP $http_code)"
          exit 1
        fi
        
        # æ£€æŸ¥å“åº”æ ¼å¼
        instance_count=$(jq -r '.instances | length // 0' /tmp/instances.json)
        echo "ğŸ“Š å‘ç° $instance_count ä¸ªå®ä¾‹"
        
        if [ "$instance_count" -eq 0 ]; then
          echo "âš ï¸ æ²¡æœ‰å‘ç°ä»»ä½•å®ä¾‹"
          echo "0" > /tmp/instance_count
          echo "0" > /tmp/active_count
          echo "" > /tmp/active_instances
          echo "" > /tmp/all_instances
        else
          # æ˜¾ç¤ºå®ä¾‹è¯¦æƒ…
          echo "ğŸ“‹ å®ä¾‹è¯¦ç»†ä¿¡æ¯:"
          jq -r '.instances[]? | 
            "ğŸ–¥ï¸ å®ä¾‹ID: \(.id // "æœªçŸ¥")
             ğŸ“ æ ‡ç­¾: \(.label // "æœªå‘½å")  
             ğŸ”‹ çŠ¶æ€: \(.status // "æœªçŸ¥") | ç”µæº: \(.power_status // "æœªçŸ¥")
             ğŸ’¾ è®¡åˆ’: \(.plan // "æœªçŸ¥") | åŒºåŸŸ: \(.region // "æœªçŸ¥")
             ğŸŒ ä¸»IP: \(.main_ip // "æœªåˆ†é…")
             ğŸ“… åˆ›å»ºæ—¶é—´: \(.date_created // "æœªçŸ¥")
             =================="' /tmp/instances.json
          
          # ä¿å­˜æ´»è·ƒå®ä¾‹IDå’Œæ‰€æœ‰å®ä¾‹ID
          jq -r '[.instances[]? | select(.status == "active") | .id] | join(" ")' /tmp/instances.json > /tmp/active_instances
          jq -r '[.instances[]? | .id] | join(" ")' /tmp/instances.json > /tmp/all_instances
          active_count=$(jq -r '[.instances[]? | select(.status == "active")] | length' /tmp/instances.json)
          
          echo "ğŸŸ¢ æ´»è·ƒå®ä¾‹æ•°é‡: $active_count"
          echo "$instance_count" > /tmp/instance_count
          echo "$active_count" > /tmp/active_count
        fi

    - name: ğŸ“¸ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ–°å¿«ç…§
      run: |
        echo "=== å¼€å§‹åˆ›å»ºæ–°å¿«ç…§ ==="
        
        active_instances=$(cat /tmp/active_instances)
        active_count=$(cat /tmp/active_count)
        
        if [ "$active_count" -eq 0 ]; then
          echo "âš ï¸ æ²¡æœ‰æ´»è·ƒå®ä¾‹ï¼Œè·³è¿‡å¿«ç…§åˆ›å»º"
          echo "" > /tmp/created_snapshots
          echo "0" > /tmp/success_count
        else
          created_snapshots=""
          success_count=0
          
          for instance_id in $active_instances; do
            if [ -n "$instance_id" ] && [ "$instance_id" != "null" ]; then
              echo "ğŸ“¸ ä¸ºå®ä¾‹ $instance_id åˆ›å»ºå¿«ç…§..."
              
              # ç”Ÿæˆå¿«ç…§æè¿°
              snapshot_desc="AutoBackup_${SNAPSHOT_TIMESTAMP}_${instance_id}"
              
              # åˆ›å»ºå¿«ç…§
              create_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
                -H "Content-Type: application/json" \
                -X POST "$VULTR_API_URL/snapshots" \
                -d "{
                  \"instance_id\": \"$instance_id\",
                  \"description\": \"$snapshot_desc\"
                }" -o /tmp/create_response.json)
              
              http_code=$(echo "$create_response" | tail -c 4)
              
              if [ "$http_code" = "201" ] || [ "$http_code" = "200" ]; then
                snapshot_id=$(jq -r '.snapshot.id // empty' /tmp/create_response.json)
                if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "null" ] && [ "$snapshot_id" != "" ]; then
                  echo "   âœ… å¿«ç…§åˆ›å»ºè¯·æ±‚æˆåŠŸ - ID: $snapshot_id"
                  created_snapshots="$created_snapshots $snapshot_id"
                  success_count=$((success_count + 1))
                else
                  echo "   âš ï¸ å¿«ç…§åˆ›å»ºå“åº”æ ¼å¼å¼‚å¸¸"
                  jq '.' /tmp/create_response.json || echo "æ— æ³•è§£æå“åº”"
                fi
              else
                echo "   âŒ å¿«ç…§åˆ›å»ºå¤±è´¥ (HTTP $http_code)"
                jq '.' /tmp/create_response.json 2>/dev/null || echo "å“åº”: $(cat /tmp/create_response.json)"
              fi
              
              # é¿å…APIé™åˆ¶
              sleep 3
            fi
          done
          
          echo "$created_snapshots" > /tmp/created_snapshots
          echo "$success_count" > /tmp/success_count
        fi
        
        echo "=== å¿«ç…§åˆ›å»ºè¯·æ±‚å®Œæˆ ==="

    - name: â³ ç¬¬å››æ­¥ï¼šç›‘æ§å¿«ç…§åˆ›å»ºçŠ¶æ€
      run: |
        echo "=== ç›‘æ§å¿«ç…§åˆ›å»ºçŠ¶æ€ ==="
        
        created_snapshots=$(cat /tmp/created_snapshots)
        timeout_minutes="$TIMEOUT_MINUTES"
        
        if [ -z "$created_snapshots" ] || [ "$(echo $created_snapshots | wc -w)" -eq 0 ]; then
          echo "âš ï¸ æ²¡æœ‰éœ€è¦ç›‘æ§çš„å¿«ç…§"
          echo "0" > /tmp/final_completed
          echo "0" > /tmp/total_snapshots
          echo "false" > /tmp/all_snapshots_complete
        else
          echo "ğŸ“Š ç›‘æ§å¿«ç…§: $created_snapshots"
          echo "â±ï¸ è¶…æ—¶æ—¶é—´: $timeout_minutes åˆ†é’Ÿ"
          
          start_time=$(date +%s)
          timeout_seconds=$((timeout_minutes * 60))
          completed_count=0
          total_snapshots=$(echo $created_snapshots | wc -w)
          
          while [ $completed_count -lt $total_snapshots ]; do
            current_time=$(date +%s)
            elapsed=$((current_time - start_time))
            
            if [ $elapsed -gt $timeout_seconds ]; then
              echo "â° ç›‘æ§è¶…æ—¶ ($timeout_minutes åˆ†é’Ÿ)"
              break
            fi
            
            echo "ğŸ”„ æ£€æŸ¥å¿«ç…§çŠ¶æ€... (å·²ç”¨æ—¶: $((elapsed/60))åˆ†é’Ÿ)"
            completed_count=0
            
            for snapshot_id in $created_snapshots; do
              if [ -n "$snapshot_id" ] && [ "$snapshot_id" != "null" ]; then
                status_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
                  "$VULTR_API_URL/snapshots/$snapshot_id" -o /tmp/status_response.json)
                
                status_http_code=$(echo "$status_response" | tail -c 4)
                
                if [ "$status_http_code" = "200" ]; then
                  status=$(jq -r '.snapshot.status // "unknown"' /tmp/status_response.json)
                  description=$(jq -r '.snapshot.description // "æœªçŸ¥"' /tmp/status_response.json)
                  
                  case "$status" in
                    "complete")
                      echo "   âœ… $snapshot_id: å®Œæˆ ($description)"
                      completed_count=$((completed_count + 1))
                      ;;
                    "pending")
                      echo "   â³ $snapshot_id: åˆ›å»ºä¸­ ($description)" 
                      ;;
                    *)
                      echo "   â“ $snapshot_id: $status ($description)"
                      ;;
                  esac
                else
                  echo "   âŒ $snapshot_id: çŠ¶æ€æ£€æŸ¥å¤±è´¥ (HTTP $status_http_code)"
                fi
              fi
            done
            
            echo "ğŸ“ˆ è¿›åº¦: $completed_count/$total_snapshots å®Œæˆ"
            
            if [ $completed_count -lt $total_snapshots ]; then
              echo "ğŸ’¤ ç­‰å¾…30ç§’åé‡æ–°æ£€æŸ¥..."
              sleep 30
            fi
          done
          
          echo "$completed_count" > /tmp/final_completed  
          echo "$total_snapshots" > /tmp/total_snapshots
          
          # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¿«ç…§éƒ½å®Œæˆ
          if [ "$completed_count" -eq "$total_snapshots" ] && [ "$total_snapshots" -gt 0 ]; then
            echo "true" > /tmp/all_snapshots_complete
            echo "ğŸ‰ æ‰€æœ‰å¿«ç…§åˆ›å»ºå®Œæˆï¼"
          else
            echo "false" > /tmp/all_snapshots_complete
            echo "âš ï¸ å¹¶éæ‰€æœ‰å¿«ç…§éƒ½å®Œæˆ"
          fi
        fi
        
        echo "=== å¿«ç…§ç›‘æ§å®Œæˆ ==="

    - name: ğŸ”¥ ç¬¬äº”æ­¥ï¼šåˆ é™¤æ‰€æœ‰å®ä¾‹
      run: |
        echo "=== åˆ é™¤æ‰€æœ‰å®ä¾‹ ==="
        
        all_snapshots_complete=$(cat /tmp/all_snapshots_complete 2>/dev/null || echo "false")
        all_instances=$(cat /tmp/all_instances 2>/dev/null || echo "")
        total_snapshots=$(cat /tmp/total_snapshots 2>/dev/null || echo "0")
        
        echo "ğŸ” æ£€æŸ¥åˆ é™¤æ¡ä»¶:"
        echo "   - åˆ é™¤å®ä¾‹è®¾ç½®: $DELETE_INSTANCES"
        echo "   - å¿«ç…§å…¨éƒ¨å®Œæˆ: $all_snapshots_complete"
        echo "   - å¿«ç…§æ€»æ•°: $total_snapshots"
        echo "   - å®ä¾‹åˆ—è¡¨: $all_instances"
        
        # æ£€æŸ¥æ˜¯å¦åº”è¯¥åˆ é™¤å®ä¾‹
        if [ "$DELETE_INSTANCES" != "true" ]; then
          echo "âš ï¸ è·³è¿‡åˆ é™¤å®ä¾‹ (delete_instances=false)"
          echo "0" > /tmp/instances_deleted
          echo "0" > /tmp/instances_delete_failed
        elif [ "$all_snapshots_complete" != "true" ]; then
          echo "âš ï¸ è·³è¿‡åˆ é™¤å®ä¾‹ (å¿«ç…§æœªå…¨éƒ¨å®Œæˆ)"
          echo "0" > /tmp/instances_deleted
          echo "0" > /tmp/instances_delete_failed
        elif [ "$total_snapshots" -eq 0 ]; then
          echo "âš ï¸ è·³è¿‡åˆ é™¤å®ä¾‹ (æ²¡æœ‰æˆåŠŸåˆ›å»ºå¿«ç…§)"
          echo "0" > /tmp/instances_deleted
          echo "0" > /tmp/instances_delete_failed
        elif [ -z "$all_instances" ]; then
          echo "â„¹ï¸ æ²¡æœ‰å®ä¾‹éœ€è¦åˆ é™¤"
          echo "0" > /tmp/instances_deleted
          echo "0" > /tmp/instances_delete_failed
        else
          echo "ğŸ”¥ å¼€å§‹åˆ é™¤æ‰€æœ‰å®ä¾‹..."
          echo "âš ï¸  è­¦å‘Š: è¿™å°†åˆ é™¤æ‰€æœ‰å®ä¾‹ï¼Œæ“ä½œä¸å¯é€†ï¼"
          
          deleted_instances=0
          failed_instances=0
          
          for instance_id in $all_instances; do
            if [ -n "$instance_id" ] && [ "$instance_id" != "null" ]; then
              # è·å–å®ä¾‹ä¿¡æ¯
              instance_info=$(curl -s -H "Authorization: Bearer $VULTR_API_KEY" \
                "$VULTR_API_URL/instances/$instance_id")
              
              instance_label=$(echo "$instance_info" | jq -r '.instance.label // "æœªçŸ¥"')
              instance_ip=$(echo "$instance_info" | jq -r '.instance.main_ip // "æœªåˆ†é…"')
              instance_status=$(echo "$instance_info" | jq -r '.instance.status // "æœªçŸ¥"')
              
              echo "ğŸ”¥ åˆ é™¤å®ä¾‹: $instance_id"
              echo "   ğŸ“ æ ‡ç­¾: $instance_label"
              echo "   ğŸŒ IP: $instance_ip" 
              echo "   ğŸ”‹ çŠ¶æ€: $instance_status"
              
              # åˆ é™¤å®ä¾‹
              delete_response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $VULTR_API_KEY" \
                -X DELETE "$VULTR_API_URL/instances/$instance_id" -o /tmp/instance_delete_response.json)
              
              delete_http_code=$(echo "$delete_response" | tail -c 4)
              
              if [ "$delete_http_code" = "204" ] || [ "$delete_http_code" = "200" ] || [ "$delete_http_code" = "404" ]; then
                echo "   âœ… å®ä¾‹åˆ é™¤æˆåŠŸ"
                deleted_instances=$((deleted_instances + 1))
              else
                echo "   âŒ å®ä¾‹åˆ é™¤å¤±è´¥ (HTTP $delete_http_code)"
                if [ -s /tmp/instance_delete_response.json ]; then
                  error_msg=$(jq -r '.error // "æœªçŸ¥é”™è¯¯"' /tmp/instance_delete_response.json)
                  echo "   é”™è¯¯ä¿¡æ¯: $error_msg"
                fi
                failed_instances=$((failed_instances + 1))
              fi
              
              # é¿å…APIé™åˆ¶
              sleep 3
            fi
          done
          
          echo "$deleted_instances" > /tmp/instances_deleted
          echo "$failed_instances" > /tmp/instances_delete_failed
          
          echo "ğŸ“Š å®ä¾‹åˆ é™¤ç»“æœ:"
          echo "   âœ… æˆåŠŸåˆ é™¤: $deleted_instances ä¸ª"
          echo "   âŒ åˆ é™¤å¤±è´¥: $failed_instances ä¸ª"
        fi
        
        echo "=== å®ä¾‹åˆ é™¤å®Œæˆ ==="

    - name: ğŸ“Š ç”Ÿæˆæ“ä½œæ€»ç»“æŠ¥å‘Š
      if: always()
      run: |
        echo "=== Vultrå¿«ç…§ç®¡ç†ä¸å®ä¾‹æ¸…ç†æ€»ç»“æŠ¥å‘Š ==="
        echo "ğŸ• æ‰§è¡Œæ—¶é—´: $WORKFLOW_START_TIME"
        echo "âš™ï¸ è§¦å‘æ–¹å¼: ${{ github.event_name }}"
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ‘¤ æ‰‹åŠ¨è§¦å‘å‚æ•°:"
          echo "   - å¼ºåˆ¶åˆ é™¤å¿«ç…§: ${{ github.event.inputs.force_delete }}"
          echo "   - è¶…æ—¶æ—¶é—´: ${{ github.event.inputs.timeout_minutes }}åˆ†é’Ÿ"
          echo "   - åˆ é™¤å®ä¾‹: ${{ github.event.inputs.delete_instances }}"
        fi
        
        echo ""
        echo "ğŸ“‹ æ“ä½œç»“æœæ€»è§ˆ:"
        
        # åˆ é™¤å¿«ç…§ç»“æœ
        deleted_count=$(cat /tmp/deleted_count 2>/dev/null || echo "0")
        failed_delete_count=$(cat /tmp/failed_delete_count 2>/dev/null || echo "0")
        echo "ğŸ—‘ï¸ æ—§å¿«ç…§åˆ é™¤: $deleted_count ä¸ªæˆåŠŸ, $failed_delete_count ä¸ªå¤±è´¥"
        
        # å®ä¾‹ä¿¡æ¯  
        total_instances=$(cat /tmp/instance_count 2>/dev/null || echo "0")
        active_instances=$(cat /tmp/active_count 2>/dev/null || echo "0") 
        echo "ğŸ–¥ï¸ å‘ç°å®ä¾‹: $total_instances ä¸ªæ€»è®¡, $active_instances ä¸ªæ´»è·ƒ"
        
        # å¿«ç…§åˆ›å»ºç»“æœ
        created_count=$(cat /tmp/success_count 2>/dev/null || echo "0")
        completed_count=$(cat /tmp/final_completed 2>/dev/null || echo "0") 
        total_snapshots=$(cat /tmp/total_snapshots 2>/dev/null || echo "0")
        echo "ğŸ“¸ å¿«ç…§åˆ›å»º: $created_count ä¸ªè¯·æ±‚, $completed_count/$total_snapshots ä¸ªå®Œæˆ"
        
        # å®ä¾‹åˆ é™¤ç»“æœ
        instances_deleted=$(cat /tmp/instances_deleted 2>/dev/null || echo "0")
        instances_delete_failed=$(cat /tmp/instances_delete_failed 2>/dev/null || echo "0")
        echo "ğŸ”¥ å®ä¾‹åˆ é™¤: $instances_deleted ä¸ªæˆåŠŸ, $instances_delete_failed ä¸ªå¤±è´¥"
        
        # ç­‰å¾…æ—¶é—´ä¿¡æ¯
        snapshots_deleted=$(cat /tmp/snapshots_deleted 2>/dev/null || echo "false")
        if [ "$snapshots_deleted" == "true" ]; then
          echo "â° åˆ é™¤ç­‰å¾…: 5åˆ†é’Ÿæ¸…ç†æ—¶é—´"
        fi
        
        # çŠ¶æ€åˆ¤æ–­
        echo ""
        echo "ğŸ¯ æœ€ç»ˆçŠ¶æ€è¯„ä¼°:"
        
        all_snapshots_complete=$(cat /tmp/all_snapshots_complete 2>/dev/null || echo "false")
        
        if [ "$all_snapshots_complete" == "true" ] && [ "$instances_deleted" -gt 0 ]; then
          echo "ğŸ‰ å®Œå…¨æˆåŠŸ: æ‰€æœ‰å¿«ç…§å®Œæˆï¼Œå®ä¾‹å·²æ¸…ç†"
          echo "ğŸ’¡ å»ºè®®: å¯ä»¥éšæ—¶ä½¿ç”¨å¿«ç…§æ¢å¤å®ä¾‹"
        elif [ "$all_snapshots_complete" == "true" ] && [ "$DELETE_INSTANCES" != "true" ]; then
          echo "âœ… å¿«ç…§æˆåŠŸ: æ‰€æœ‰å¿«ç…§å®Œæˆï¼Œå®ä¾‹ä¿ç•™"
          echo "ğŸ’¡ æç¤º: å¦‚éœ€æ¸…ç†å®ä¾‹ï¼Œè¯·è®¾ç½® delete_instances=true"
        elif [ "$all_snapshots_complete" == "true" ] && [ "$instances_deleted" -eq 0 ]; then
          echo "âš ï¸ éƒ¨åˆ†å®Œæˆ: å¿«ç…§æˆåŠŸä½†å®ä¾‹åˆ é™¤å¤±è´¥"
          echo "ğŸ’¡ å»ºè®®: æ£€æŸ¥å®ä¾‹åˆ é™¤å¤±è´¥åŸå› "
        elif [ "$completed_count" -gt 0 ]; then
          echo "âš ï¸ éƒ¨åˆ†æˆåŠŸ: éƒ¨åˆ†å¿«ç…§å®Œæˆ"
          echo "ğŸ’¡ å»ºè®®: æ£€æŸ¥æœªå®Œæˆçš„å¿«ç…§çŠ¶æ€"
        elif [ "$total_snapshots" -gt 0 ]; then
          echo "âŒ ä»»åŠ¡å¤±è´¥: å¿«ç…§åˆ›å»ºå¤±è´¥"
          echo "ğŸ’¡ å»ºè®®: æ£€æŸ¥APIæƒé™å’Œå®ä¾‹çŠ¶æ€"
        else
          echo "ğŸ’¡ æ— æ“ä½œ: æ²¡æœ‰éœ€è¦å¤„ç†çš„å®ä¾‹"
        fi
        
        # å®‰å…¨æç¤º
        if [ "$instances_deleted" -gt 0 ]; then
          echo ""
          echo "ğŸ”’ å®‰å…¨æé†’:"
          echo "   âš ï¸ $instances_deleted ä¸ªå®ä¾‹å·²è¢«æ°¸ä¹…åˆ é™¤"
          echo "   ğŸ“¸ å¯ä½¿ç”¨åˆ›å»ºçš„å¿«ç…§æ¢å¤å®ä¾‹"
          echo "   ğŸ’° åˆ é™¤å®ä¾‹å°†åœæ­¢è®¡è´¹"
        fi
        
        exit 0
